#!/usr/bin/env bash
# WhisperX transcription wrapper
# Uses system-installed whisperx (pip install whisperx)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if whisperx is available
if ! command -v whisperx &> /dev/null; then
    # Try venv
    SKILL_DIR="$(dirname "$SCRIPT_DIR")"
    VENV_PYTHON="$SKILL_DIR/.venv/bin/python"
    SETUP_SCRIPT="$SKILL_DIR/setup.sh"

    if [ ! -f "$VENV_PYTHON" ]; then
        echo "ðŸŽ™ï¸ WhisperX not found. Running setup..." >&2
        echo "" >&2

        if [ -f "$SETUP_SCRIPT" ]; then
            bash "$SETUP_SCRIPT"
            echo "" >&2

            if [ ! -f "$VENV_PYTHON" ]; then
                echo "âŒ Setup failed. Please check errors above." >&2
                exit 1
            fi
        else
            echo "âŒ Setup script not found: $SETUP_SCRIPT" >&2
            echo "   Install manually: pip install whisperx" >&2
            exit 1
        fi
    fi

    exec "$VENV_PYTHON" "$SCRIPT_DIR/transcribe.py" "$@"
else
    exec python3 "$SCRIPT_DIR/transcribe.py" "$@"
fi
